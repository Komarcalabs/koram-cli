<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Koram Deployer | Nuxt</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#7001e6",
              "primary-light": "#9d4eff",
              "bg-dark": "#0a0a0c",
              success: "#00ff88",
              error: "#ff4d4d",
              "text-dim": "#a0a0a0",
              "card-bg": "rgba(255, 255, 255, 0.05)",
              border: "rgba(255, 255, 255, 0.1)",
            },
            fontFamily: {
              outfit: ["Outfit", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer base {
        body {
          @apply bg-bg-dark text-white font-outfit min-h-screen flex items-center justify-center p-5;
          background-image:
            radial-gradient(
              circle at 20% 20%,
              rgba(112, 1, 230, 0.15) 0%,
              transparent 40%
            ),
            radial-gradient(
              circle at 80% 80%,
              rgba(157, 78, 255, 0.1) 0%,
              transparent 40%
            );
        }
      }
      @layer components {
        .glass-card {
          @apply bg-card-bg backdrop-blur-3xl border border-border rounded-3xl shadow-2xl;
        }
        .input-text {
          @apply bg-white/5 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-primary focus:bg-white/10 transition-all shadow-inner;
        }
        .btn-primary {
          @apply bg-gradient-to-br from-primary to-primary-light text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:-translate-y-0.5 hover:shadow-primary/20 active:translate-y-0 disabled:bg-neutral-800 disabled:text-neutral-500 disabled:shadow-none disabled:cursor-not-allowed transition-all;
        }
        .btn-secondary {
          @apply bg-transparent border border-border font-semibold py-3.5 px-6 rounded-xl hover:bg-white/5 transition-all;
        }
        .table-input {
          @apply bg-transparent border-none w-full text-white py-2 focus:outline-none focus:text-primary-light transition-colors;
        }
      }
      [v-cloak] {
        display: none;
      }
      ::-webkit-scrollbar {
        width: 5px;
      }
      ::-webkit-scrollbar-thumb {
        @apply bg-white/10 rounded-full;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      v-cloak
      class="w-full max-w-[1100px] glass-card p-10 grid grid-cols-1 lg:grid-cols-2 gap-10 relative"
    >
      <header class="lg:col-span-2 flex justify-between items-center mb-2">
        <div
          class="text-3xl font-semibold bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent tracking-tighter"
        >
          Koram Deployer 2.0
        </div>
        <div
          v-if="isConnected"
          class="px-4 py-1.5 rounded-full text-xs font-semibold bg-success/10 text-success border border-success/20 animate-pulse"
        >
          En L√≠nea
        </div>
      </header>

      <!-- COLUMNA 1: CONFIGURACI√ìN BASE -->
      <div class="flex flex-col gap-5">
        <div class="flex flex-col gap-2">
          <label
            class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
            >Configuraci√≥n (.koram-rc)</label
          >
          <select
            v-model="selectedConfig"
            @change="loadConfig"
            class="input-text"
          >
            <option v-for="item in configs" :key="item" :value="item">
              {{ item }}
            </option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="flex flex-col gap-2">
            <label
              class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
              >Usuario</label
            >
            <input type="text" v-model="form.server.user" class="input-text" />
          </div>
          <div class="grid grid-cols-[2fr,1fr] gap-2">
            <div class="flex flex-col gap-2">
              <label
                class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
                >Host</label
              >
              <input
                type="text"
                v-model="form.server.host"
                class="input-text"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label
                class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
                >Puerto</label
              >
              <input
                type="number"
                v-model="form.server.port"
                placeholder="22"
                class="input-text"
              />
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label
            class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
            >Ruta Remota</label
          >
          <input type="text" v-model="form.deploy.path" class="input-text" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="flex flex-col gap-2">
            <label
              class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
              >PM2 Name</label
            >
            <input type="text" v-model="form.name" class="input-text" />
          </div>
          <div class="flex flex-col gap-2">
            <label
              class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
              >Build Env</label
            >
            <select v-model="form.buildEnv" class="input-text">
              <option v-for="env in envFiles" :key="env" :value="env">
                {{ env }}
              </option>
            </select>
          </div>
        </div>

        <div
          class="bg-white/5 border border-border p-4 rounded-xl grid grid-cols-2 gap-x-4 gap-y-2"
        >
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">¬øUsar PM2?</span>
            <input
              type="checkbox"
              v-model="form.advanced.usePm2"
              class="w-5 h-5 accent-primary"
            />
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium">Optimizar (Sv)</span>
            <input
              type="checkbox"
              v-model="form.advanced.optimizeNpm"
              class="w-5 h-5 accent-primary"
            />
          </div>
          <div
            class="flex items-center justify-between col-span-2 mt-1 pt-1 border-t border-border"
          >
            <span class="text-sm font-medium">NPM Install Local</span>
            <input
              type="checkbox"
              v-model="form.advanced.localNpmInstall"
              class="w-5 h-5 accent-primary"
            />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-2">
          <button
            @click="saveConfig"
            class="btn-secondary flex items-center justify-center gap-2"
            :disabled="busy"
          >
            <span>üíæ</span> Guardar
          </button>
          <button
            @click="showLogsModal = true"
            class="btn-secondary flex items-center justify-center gap-2"
          >
            <span>üìú</span> Ver Logs
          </button>
        </div>
      </div>

      <!-- COLUMNA 2: TABLAS -->
      <div class="flex flex-col gap-5">
        <!-- Pre-Deploy -->
        <div class="flex flex-col gap-2">
          <label
            class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
            >Comandos Pre-Deploy (Remotos)</label
          >
          <div
            class="border border-border rounded-xl overflow-hidden bg-black/20"
          >
            <table class="w-full text-xs">
              <thead class="bg-white/5">
                <tr>
                  <th
                    class="px-4 py-2 text-left font-semibold text-text-dim uppercase tracking-tighter"
                  >
                    Comando
                  </th>
                  <th class="w-10"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr
                  v-for="(cmd, index) in form.deploy.preDeploy"
                  :key="'pre-'+index"
                >
                  <td class="px-4 py-1">
                    <input
                      class="table-input"
                      v-model="form.deploy.preDeploy[index]"
                      placeholder="ej: npm run lint"
                    />
                  </td>
                  <td class="px-2 text-center">
                    <button
                      class="text-text-dim hover:text-error transition-colors text-lg"
                      @click="form.deploy.preDeploy.splice(index, 1)"
                    >
                      √ó
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div
              class="py-2.5 text-center text-[11px] font-bold text-primary-light cursor-pointer hover:bg-white/5 transition-colors uppercase"
              @click="form.deploy.preDeploy.push('')"
            >
              + Agregar Comando
            </div>
          </div>
        </div>

        <!-- Env Vars -->
        <div class="flex flex-col gap-2">
          <label
            class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
            >Variables de Entorno (.env remoto)</label
          >
          <div
            class="border border-border rounded-xl overflow-hidden bg-black/20"
          >
            <table class="w-full text-xs">
              <thead class="bg-white/5">
                <tr>
                  <th
                    class="px-4 py-2 text-left font-semibold text-text-dim uppercase tracking-tighter"
                  >
                    Key
                  </th>
                  <th
                    class="px-4 py-2 text-left font-semibold text-text-dim uppercase tracking-tighter"
                  >
                    Value
                  </th>
                  <th class="w-10"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr v-for="(val, key) in form.env" :key="key">
                  <td class="px-4 py-1">
                    <input
                      class="table-input font-bold"
                      :value="key"
                      @input="updateEnvKey(key, $event.target.value)"
                      placeholder="KEY"
                    />
                  </td>
                  <td class="px-4 py-1">
                    <input
                      class="table-input"
                      v-model="form.env[key]"
                      placeholder="VALUE"
                    />
                  </td>
                  <td class="px-2 text-center">
                    <button
                      class="text-text-dim hover:text-error transition-colors text-lg"
                      @click="delete form.env[key]"
                    >
                      √ó
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div
              class="py-2.5 text-center text-[11px] font-bold text-primary-light cursor-pointer hover:bg-white/5 transition-colors uppercase"
              @click="addEnvRow()"
            >
              + Agregar Variable
            </div>
          </div>
        </div>

        <!-- Post-Deploy -->
        <div class="flex flex-col gap-2">
          <label
            class="text-[11px] font-semibold text-text-dim uppercase tracking-wider"
            >Comandos Post-Deploy (Remotos)</label
          >
          <div
            class="border border-border rounded-xl overflow-hidden bg-black/20"
          >
            <table class="w-full text-xs">
              <thead class="bg-white/5">
                <tr>
                  <th
                    class="px-4 py-2 text-left font-semibold text-text-dim uppercase tracking-tighter"
                  >
                    Comando
                  </th>
                  <th class="w-10"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <tr
                  v-for="(cmd, index) in form.deploy.postDeploy"
                  :key="'post-'+index"
                >
                  <td class="px-4 py-1">
                    <input
                      class="table-input"
                      v-model="form.deploy.postDeploy[index]"
                      placeholder="ej: ./scripts/after-deploy.sh"
                    />
                  </td>
                  <td class="px-2 text-center">
                    <button
                      class="text-text-dim hover:text-error transition-colors text-lg"
                      @click="form.deploy.postDeploy.splice(index, 1)"
                    >
                      √ó
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div
              class="py-2.5 text-center text-[11px] font-bold text-primary-light cursor-pointer hover:bg-white/5 transition-colors uppercase"
              @click="form.deploy.postDeploy.push('')"
            >
              + Agregar Comando
            </div>
          </div>
        </div>

        <button
          @click="startDeploy"
          class="btn-primary w-full mt-2"
          :disabled="busy"
        >
          <span v-if="busy">‚ö° Desplegando...</span>
          <span v-else>üöÄ Iniciar Despliegue</span>
        </button>
      </div>

      <!-- MODAL DE LOGS -->
      <transition name="fade">
        <div
          v-if="showLogsModal || busy"
          class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-md"
        >
          <div
            class="w-full max-w-4xl h-[85vh] bg-bg-dark border border-white/10 rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-300"
          >
            <header
              class="px-8 py-5 border-b border-white/5 flex justify-between items-center bg-white/5"
            >
              <div class="flex items-center gap-3">
                <div
                  v-if="busy"
                  class="w-3 h-3 bg-primary-light rounded-full animate-ping"
                ></div>
                <div v-else class="w-3 h-3 bg-success rounded-full"></div>
                <h2 class="font-semibold text-lg uppercase tracking-tight">
                  Proceso de Despliegue
                </h2>
              </div>
              <button
                @click="showLogsModal = false"
                v-if="!busy"
                class="text-text-dim hover:text-white transition-all text-sm font-bold bg-white/5 px-4 py-2 rounded-xl border border-white/10"
              >
                ESC / CERRAR
              </button>
            </header>

            <div
              id="logs-modal-container"
              class="flex-grow p-8 font-mono text-[13px] overflow-y-auto leading-relaxed scroll-smooth bg-black/20"
            >
              <div
                v-for="(log, index) in logs"
                :key="index"
                :class="['mb-2 flex gap-4', log.level === 'success' ? 'text-success' : log.level === 'error' ? 'text-error' : log.level === 'info' ? 'text-primary-light' : 'text-neutral-400']"
              >
                <span class="opacity-30 shrink-0 select-none"
                  >[{{ log.time }}]</span
                >
                <span class="break-words">{{ log.message }}</span>
              </div>
              <div
                v-if="busy"
                class="mt-4 flex items-center gap-3 text-primary-light"
              >
                <span class="animate-pulse">_</span>
                <span
                  class="text-xs uppercase tracking-widest font-bold opacity-50"
                  >Esperando ejecuci√≥n...</span
                >
              </div>
            </div>

            <footer
              class="px-8 py-4 border-t border-white/5 bg-white/5 flex justify-between items-center"
            >
              <div
                class="text-[10px] text-text-dim uppercase font-bold tracking-widest"
              >
                Koram Engine v2.0
              </div>
              <div
                v-if="busy"
                class="text-primary-light text-xs font-bold animate-pulse"
              >
                DESPLEGANDO ACTIVAMENTE
              </div>
              <div
                v-else
                class="text-success text-xs font-bold uppercase tracking-widest leading-none flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M5 13l4 4L19 7"
                  ></path>
                </svg>
                FINALIZADO
              </div>
            </footer>

            <div
              v-if="deployedUrl && !busy"
              class="px-8 pb-8 pt-0 flex justify-center"
            >
              <a
                :href="deployedUrl"
                target="_blank"
                class="w-full btn-primary text-center flex items-center justify-center gap-2 text-base"
              >
                <span>üåç</span> Abrir Aplicaci√≥n
              </a>
            </div>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted, watch } = Vue;

      createApp({
        setup() {
          const isConnected = ref(false);
          const busy = ref(false);
          const showLogsModal = ref(false);
          const deployedUrl = ref("");
          const selectedConfig = ref("");
          const configs = ref([]);
          const envFiles = ref([]);
          const logs = ref([
            {
              time: new Date().toLocaleTimeString(),
              message: "Panel operativo listo.",
              level: "info",
            },
          ]);

          const form = reactive({
            name: "",
            server: { user: "", host: "", port: 22 },
            deploy: { path: "", preDeploy: [], postDeploy: [] },
            env: {},
            buildEnv: "",
            advanced: {
              usePm2: true,
              optimizeNpm: true,
              localNpmInstall: false,
            },
          });

          let ws;

          const scrollLogs = () => {
            setTimeout(() => {
              const el = document.getElementById("logs-modal-container");
              if (el) el.scrollTop = el.scrollHeight;
            }, 50);
          };

          const connectWS = () => {
            ws = new WebSocket(`ws://${location.host}`);
            ws.onopen = () => (isConnected.value = true);
            ws.onmessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === "log") {
                logs.value.push({
                  time: new Date().toLocaleTimeString(),
                  message: data.message,
                  level: data.level,
                });
                scrollLogs();
              } else if (data.type === "configs") {
                configs.value = data.items;
                selectedConfig.value =
                  data.selected || (data.items.length > 0 ? data.items[0] : "");
                envFiles.value = data.envs;
              } else if (data.type === "config_data") {
                const d = data.data;
                const pm2Name = d.processes?.app?.command
                  ?.split("--name")?.[1]
                  ?.trim();
                form.name = d.name || pm2Name || "";
                Object.assign(form.server, d.server || {});
                form.deploy.path = d.deploy?.path || "";
                form.deploy.preDeploy = d.deploy?.preDeploy || [];
                form.deploy.postDeploy = d.deploy?.postDeploy || [];
                Object.assign(form.advanced, d.advanced || {});
                form.env = d.env || {};
                form.buildEnv = d.buildEnv || "";
              } else if (data.type === "status") {
                busy.value = data.busy;
                if (data.busy) {
                  showLogsModal.value = true;
                  deployedUrl.value = "";
                }
              } else if (data.type === "deploy_success") {
                deployedUrl.value = data.url;
              }
            };
            ws.onclose = () => {
              isConnected.value = false;
              setTimeout(connectWS, 2000);
            };
          };

          const addEnvRow = () => {
            const newKey = "NEW_VAR_" + Object.keys(form.env).length;
            form.env[newKey] = "";
          };

          const updateEnvKey = (oldKey, newKey) => {
            if (oldKey === newKey) return;
            const val = form.env[oldKey];
            delete form.env[oldKey];
            form.env[newKey] = val;
          };

          const saveConfig = () => {
            ws.send(
              JSON.stringify({
                type: "save_config",
                name: selectedConfig.value,
                data: JSON.parse(JSON.stringify(form)),
              }),
            );
            logs.value.push({
              time: new Date().toLocaleTimeString(),
              message: "‚úÖ Configuraci√≥n guardada.",
              level: "success",
            });
          };

          const loadConfig = () => {
            ws.send(
              JSON.stringify({
                type: "load_config",
                name: selectedConfig.value,
              }),
            );
          };

          const startDeploy = () => {
            logs.value = [
              {
                time: new Date().toLocaleTimeString(),
                message: "üöÄ Iniciando despliegue...",
                level: "info",
              },
            ];
            showLogsModal.value = true;
            deployedUrl.value = "";
            ws.send(
              JSON.stringify({
                type: "start_deploy",
                name: selectedConfig.value,
              }),
            );
          };

          onMounted(connectWS);

          return {
            isConnected,
            busy,
            showLogsModal,
            deployedUrl,
            selectedConfig,
            configs,
            envFiles,
            logs,
            form,
            addEnvRow,
            updateEnvKey,
            saveConfig,
            loadConfig,
            startDeploy,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
